# =========================================================================
# CITRIX SMB DRIVE MAPPER  - DEFINITIEF & GESTROOMDLIJND
# =========================================================================

<#
.SYNOPSIS
  Map T: (Shared) en H: (Private User Home) netwerkdrives in een Citrix/SMB omgeving.

.DESCRIPTION
  Dit script is ontworpen om robuust netwerkdrives te mappen in een omgeving waar 
  de gebruikersnaam moet worden geparsed (laatste 2 karakters verwijderd) en waar
  een expliciete gebruikersnaam/wachtwoord authenticatie vereist is (via een GUI-popup).
  
  Het voert een agressieve cleanup uit van bestaande mappings om conflicten te voorkomen.
  Het logt alle stappen naar een lokaal bestand voor troubleshooting in %LOCALAPPDATA%\Pz5449.

.PARAMETER Geen
  Dit script accepteert geen parameters omdat alle informatie (gebruikersnaam, mappings) 
  uit de omgeving en de hardgecodeerde configuratie wordt gehaald.

.EXAMPLE
  PS C:\> .\SMBDriveMapper.ps1
  
  Voert het script uit. Er verschijnt een Windows Form waarin de gebruiker
  het Citrix wachtwoord moet invoeren.
#>

# --- 0. Laad benodigde Assemblies voor de GUI ---
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# --- 2. Setup Logging ---
$roamingFolder = Join-Path $Env:LOCALAPPDATA -ChildPath "Pz5449"
if (!(Test-Path $roamingFolder)) { New-Item -ItemType Directory -Path $roamingFolder | Out-Null }
Start-Transcript -Path (Join-Path $roamingFolder -ChildPath "SMBdriveMapper.log") -Force

Write-Output "=== Start SMBdriveMapper Script (Gestroomlijnde Versie) ==="

# ------------------------------
# Functie: bestaande mappings verwijderen (SCHONE OPRUIMING)
# ------------------------------
function Remove-ExistingMapping {
    param([string]$DriveLetter)
    
    $DriveSpec = "${DriveLetter}:"

    try {
        Write-Output "INFO: Start verwijdering voor ${DriveSpec}..."
        
        # 1. Probeer te verwijderen via Native PowerShell (PSDrive)
        Remove-PSDrive -Name $DriveLetter -Force -ErrorAction SilentlyContinue
        
        # 2. Probeer te verwijderen via NET USE (Windows Network Connection)
        # 2>&1 leidt de foutstroom om, Out-Null onderdrukt de "niet gevonden" fouten.
        cmd /c "net use ${DriveSpec} /delete /y 2>&1" | Out-Null
        
        Write-Output "INFO: Opruiming voor ${DriveSpec} voltooid (indien aanwezig)."
        
    } catch {
        Write-Output "WARNING: Onverwachte fout bij opruiming ${DriveSpec}: $($_.Exception.Message)"
    }
}

# ------------------------------
# 1. DEFINITIEVE MAPPINGS ARRAY
# ------------------------------
$Drives = @(
    @{ Letter = "T"; Path = "\\ctx-file01.pzoostende.be\PZOostende" },
    @{ Letter = "H"; Path = "\\ctx-file01.pzoostende.be\users$" }
)

# ------------------------------
# EERSTE STAP: CLEANUP LOOP (Logische loop 1/3)
# ------------------------------
Write-Output "--- START: CLEANUP OUDE MAPPINGS ---"
foreach ($drive in $Drives) {
    Remove-ExistingMapping -DriveLetter $drive.Letter
}
Write-Output "--- EINDE: CLEANUP OUDE MAPPINGS ---"


# ------------------------------
# 3. Gebruikersnaam ophalen en PrivPath instellen (DYNAMISCH)
# ------------------------------
$userSpecificPath = $null
$loginUserWithDomain = $null

try {
    $currentUserName = $Env:USERNAME
    
    if ([string]::IsNullOrWhiteSpace($currentUserName)) {
        throw "Geen omgevingsvariabele gebruikersnaam gevonden."
    }
    
    # Logica om de laatste 2 karakters te verwijderen voor de Citrix-gebruiker
    $CitrixUserBase = if ($currentUserName.Length -gt 2) { 
        $currentUserName.Substring(0, $currentUserName.Length - 2)
    } else { 
        $currentUserName 
    }

    # Het domein/gebruikersformaat voor netwerk-authenticatie
    $loginUserWithDomain = "PZOOSTENDE\p$CitrixUserBase"
    
    # Het user-specifieke pad voor de privémap (H:)
    $userSpecificPath = "\p$CitrixUserBase"
    
    Write-Output "INFO: Gevormde aanmeldgebruiker: $loginUserWithDomain"
    Write-Output "INFO: Gevormde gebruikersubmap: $userSpecificPath"

} catch {
    Write-Output "ERROR: Fout bij ophalen/vormen gebruikersnaam: $($_.Exception.Message)"
    Stop-Transcript
    Exit
}

# ------------------------------
# 4. Authenticatieformulier bouwen 
# ------------------------------
function Show-LoginForm {
    param([string]$DefaultUser)
    
    # VORM ELEMENTEN
    $form = New-Object System.Windows.Forms.Form
    $form.Text = "Citrix mappen toevoegen"
    $form.Size = New-Object System.Drawing.Size(300,200)
    $form.StartPosition = 'CenterScreen'
    $form.TopMost = $true
    $form.MinimizeBox = $false
    $form.MaximizeBox = $false

    $label1 = New-Object System.Windows.Forms.Label; $label1.Text = "Citrix gebruikersnaam:"; $label1.Location = New-Object System.Drawing.Point(10,20); $form.Controls.Add($label1)
    $textbox1 = New-Object System.Windows.Forms.TextBox; $textbox1.Text = $DefaultUser; $textbox1.Location = New-Object System.Drawing.Point(10,40); $textbox1.Size = New-Object System.Drawing.Size(260,20); $form.Controls.Add($textbox1)
    $label2 = New-Object System.Windows.Forms.Label; $label2.Text = "Citrix wachtwoord:"; $label2.Location = New-Object System.Drawing.Point(10,70); $form.Controls.Add($label2)
    $textbox2 = New-Object System.Windows.Forms.MaskedTextBox; $textbox2.PasswordChar = '*'; $textbox2.Location = New-Object System.Drawing.Point(10,90); $textbox2.Size = New-Object System.Drawing.Size(260,20); $form.Controls.Add($textbox2)

    $OKButton = New-Object System.Windows.Forms.Button; $OKButton.Text = "Aanmelden"; $OKButton.Location = New-Object System.Drawing.Point(70,130); $form.Controls.Add($OKButton)
    $CancelButton = New-Object System.Windows.Forms.Button; $CancelButton.Text = "Annuleren"; $CancelButton.Location = New-Object System.Drawing.Point(160,130); $form.Controls.Add($CancelButton)

    $form.AcceptButton = $OKButton; $form.CancelButton = $CancelButton

    $result = New-Object PSObject -Property @{ Username = $null; Password = $null; Cancelled = $false }

    # EVENT HANDLERS
    $OKButton.Add_Click({ $result.Username = $textbox1.Text; $result.Password = $textbox2.Text; $form.Close() })
    $CancelButton.Add_Click({ $result.Cancelled = $true; $form.Close() })
    $form.Add_Shown({ $textbox2.Focus() })
    
    $form.ShowDialog() | Out-Null
    return $result
}

# ------------------------------
# 5. AUTHENTICATIE-LOOP (Login vragen)
# ------------------------------
$authenticated = $false
$credentials = $null
$maxAttempts = 3
$attempt = 0

do {
    $attempt++
    Write-Output "INFO: Start authenticatiepoging $attempt van $maxAttempts..."

    $login = Show-LoginForm -DefaultUser $loginUserWithDomain

    if ($login.Cancelled) {
        Write-Output "INFO: Authenticatie geannuleerd door gebruiker."
        Stop-Transcript; Exit
    }
    if ([string]::IsNullOrWhiteSpace($login.Password)) {
        [System.Windows.Forms.MessageBox]::Show("Het wachtwoord mag niet leeg zijn.", "Fout", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Warning)
        continue
    }

    $secpasswd = ConvertTo-SecureString $login.Password -AsPlainText -Force
    $credentials = New-Object System.Management.Automation.PSCredential ($login.Username, $secpasswd)
    
    $authTestPath = $Drives[0].Path # Gebruik het T: pad voor de test
    Write-Output "INFO: Authenticatie testen voor $($login.Username) tegen $authTestPath..."

    try {
        New-PSDrive -Name "TempPzTest" -PSProvider FileSystem -Root $authTestPath -Credential $credentials -ErrorAction Stop | Out-Null
        Remove-PSDrive -Name "TempPzTest" -Force
        
        Write-Output "INFO: Authenticatie geslaagd."
        $authenticated = $true
        
    } catch {
        [System.Windows.Forms.MessageBox]::Show("Gebruikersnaam of wachtwoord is onjuist. Poging $attempt van $maxAttempts.", "Authenticatie mislukt", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error)
        Write-Output "WARNING: Verkeerde login. Fout: $($_.Exception.Message)"
        Start-Sleep -Milliseconds 500
    }

} until ($authenticated -or $attempt -ge $maxAttempts)

if (-not $authenticated) {
    Write-Output "ERROR: Maximum aantal authenticatiepogingen bereikt. Script stopt."
    Stop-Transcript; Exit
}

# ------------------------------
# 6. MAPPING LOOP (Logische loop 2/3)
# ------------------------------
$restartExplorer = $false
Write-Output "--- START: MAPPINGS AANMAKEN ---"

foreach ($drive in $Drives) {
    
    $DriveLetter = $drive.Letter
    
    # PADBESTEMMING BEPALEN: Gebruik de dynamisch ingestelde $userSpecificPath voor H:
    if ($DriveLetter -eq "H") { 
        $FinalPath = $drive.Path + $userSpecificPath 
    } else { 
        $FinalPath = $drive.Path 
    }
    
    Write-Output "INFO: Mapping toevoegen ${DriveLetter}: naar $FinalPath..."

    try {
        New-PSDrive -Name $DriveLetter -PSProvider FileSystem -Root $FinalPath -Credential $credentials -Persist -ErrorAction Stop
        Write-Output "INFO: Mapping ${DriveLetter}: succesvol aangemaakt."
        $restartExplorer = $true
    } catch {
        Write-Output "ERROR: Kon mapping ${DriveLetter}: niet aanmaken naar $FinalPath. Fout: $($_.Exception.Message)"
    }
}
Write-Output "--- EINDE: MAPPINGS AANMAKEN ---"


# ------------------------------
# 7. Explorer herstarten
# ------------------------------
if ($restartExplorer) {
    Write-Output "INFO: Explorer proces herstarten..."
    Get-Process -Name Explorer -ErrorAction SilentlyContinue | Stop-Process -Force
}

Write-Output "=== Script voltooid ==="
Stop-Transcript